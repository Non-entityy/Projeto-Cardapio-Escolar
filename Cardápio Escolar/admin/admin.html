<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel Admin ‚Äî Card√°pio Escolar (Prot√≥tipo)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--primary:#2e8b57;--danger:#e53935;--muted:#666}
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:#f4f7f6;padding:18px}
.container{max-width:1200px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.header h1{margin:0;color:var(--primary)}
.layout{display:grid;grid-template-columns:360px 1fr;gap:14px}
.panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
.section-title{font-weight:700;margin-bottom:8px}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
.small{font-size:13px;color:var(--muted)}
.btn{background:var(--primary);color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
.btn.danger{background:var(--danger)}
.list{max-height:420px;overflow:auto;margin-top:8px}
.item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:8px;background:#fcfffb}
.item .meta{font-size:13px;color:#333}
.item .actions{display:flex;gap:6px}
.kv{font-weight:600}
.week-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.grid-preview{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
.preview-card{background:#fff;padding:10px;border-radius:8px;border:1px solid #f0f0f0}
.footer{margin-top:10px;font-size:13px;color:var(--muted)}
@media(max-width:980px){.layout{grid-template-columns:1fr;}}
.clear-data-btn{position:fixed;bottom:20px;right:20px;background:var(--danger);color:#fff;padding:12px 18px;border-radius:50px;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(229,57,53,0.4);font-weight:600;z-index:1000;transition:all 0.3s ease}
.clear-data-btn:hover{background:#c62828;box-shadow:0 6px 16px rgba(229,57,53,0.6);transform:translateY(-2px)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Painel Administrativo ‚Äî Card√°pio Escolar</h1>
    <div>
      <button class="btn" id="openPublic">Abrir Visualizador</button>
      <button class="btn" id="exportBtn">Exportar JSON</button>
      <button class="btn" id="importBtn">Importar JSON</button>
    </div>
  </div>

  <div class="layout">
    <!-- left: meal manager -->
    <div class="panel">
      <div class="section-title">Gerenciar Refei√ß√µes</div>
      <div class="form-row">
        <input id="mealName" class="input" placeholder="Nome da refei√ß√£o (ex: Frango grelhado)" />
      </div>
      <div class="form-row">
        <input id="mealCalories" class="input" placeholder="Calorias (kcal)" type="number" />
      </div>
      <div class="form-row">
        <select id="mealGroup" class="input">
          <option value="">Grupo alimentar (opcional)</option>
          <option>Prote√≠na</option>
          <option>Carboidrato</option>
          <option>Fruta</option>
          <option>Vegetal</option>
          <option>Sopa</option>
          <option>Cereal/P√£es</option>
        </select>
      </div>
      <div class="form-row">
        <input id="mealSubstitutes" class="input" placeholder="Substitui√ß√µes (ex: Peixe assado)" />
      </div>
      <div class="form-row">
        <input id="mealAllergens" class="input" placeholder="Alerg√™nicos (ex: Gl√∫ten, Lactose)" />
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="addMealBtn">Adicionar / Atualizar Refei√ß√£o</button>
        <button class="btn" id="clearMealBtn">Limpar</button>
      </div>

      <div class="section-title" style="margin-top:12px">Refei√ß√µes Cadastradas</div>
      <div id="mealsList" class="list"></div>
    </div>

    <!-- right: week builder -->
    <div class="panel">
      <div class="section-title">Montar Card√°pio Semanal</div>
      <div class="small">Selecione as refei√ß√µes j√° cadastradas para cada dia e per√≠odo (Segunda ‚Üí Domingo).</div>

      <div style="margin-top:10px">
        <label class="small">Semana de refer√™ncia (selecione qualquer data da semana desejada):</label>
        <input id="weekStart" type="date" class="input" style="max-width:220px" />
        <div id="weekInfo" class="small" style="margin-top:4px;color:var(--primary);font-weight:600"></div>
      </div>

      <div style="margin-top:8px" id="weekBuilder"></div>

      <div class="week-controls">
        <button class="btn" id="saveWeekBtn">Salvar Semana</button>
        <button class="btn" id="dupWeekBtn">Duplicar Semana (criar nova a partir desta)</button>
        <button class="btn" id="clearWeekBtn">Limpar Sele√ß√µes</button>
      </div>

      <div style="margin-top:12px" class="section-title">Pr√©-visualiza√ß√£o R√°pida</div>
      <div id="previewGrid" class="grid-preview"></div>

      <div style="margin-top:12px" class="section-title">Semanas Salvas</div>
      <div id="weeksList" class="list"></div>

      <div class="footer">
        <div class="small">Dados salvos localmente no navegador. Quando estiver pronto, posso ajudar a converter isso para um backend (API + banco).</div>
      </div>
    </div>

  </div>
</div>

<button class="clear-data-btn" id="clearDataBtn">üóëÔ∏è Limpar Dados</button>

<script>
/*
 admin/admin.html
 - CRUD de refei√ß√µes (id, name, calories, group, substitutes, allergens)
 - Construtor de semana (dias 0-6) com selects para cafe/almoco/lanche
 - Salva em LocalStorage: meals_v1 (array), weeks_v1 (object keyed by weekStart ISO)
 - Export / Import JSON para testes e transfer√™ncia
*/

const LS_MEALS = 'meals_v1';
const LS_WEEKS = 'weeks_v1';

function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9); }
function loadMeals(){ try { return JSON.parse(localStorage.getItem(LS_MEALS)) || []; } catch(e){ return []; } }
function saveMeals(arr){ localStorage.setItem(LS_MEALS, JSON.stringify(arr)); }
function loadWeeks(){ try { return JSON.parse(localStorage.getItem(LS_WEEKS)) || {}; } catch(e){ return {}; } }
function saveWeeks(obj){ localStorage.setItem(LS_WEEKS, JSON.stringify(obj)); }

let meals = loadMeals();
let weeks = loadWeeks();
let editingMealId = null;

const mealName = document.getElementById('mealName');
const mealCalories = document.getElementById('mealCalories');
const mealGroup = document.getElementById('mealGroup');
const mealSubstitutes = document.getElementById('mealSubstitutes');
const mealAllergens = document.getElementById('mealAllergens');
const addMealBtn = document.getElementById('addMealBtn');
const clearMealBtn = document.getElementById('clearMealBtn');
const mealsList = document.getElementById('mealsList');

const weekStartInput = document.getElementById('weekStart');
const weekBuilder = document.getElementById('weekBuilder');
const saveWeekBtn = document.getElementById('saveWeekBtn');
const dupWeekBtn = document.getElementById('dupWeekBtn');
const clearWeekBtn = document.getElementById('clearWeekBtn');
const previewGrid = document.getElementById('previewGrid');
const weeksList = document.getElementById('weeksList');

document.getElementById('openPublic').addEventListener('click', ()=>{ window.open('../public/index.html','_blank'); });
document.getElementById('exportBtn').addEventListener('click', exportJSON);
document.getElementById('importBtn').addEventListener('click', importJSON);

addMealBtn.addEventListener('click', ()=>{
  const name = mealName.value.trim();
  const cal = Number(mealCalories.value) || 0;
  if(!name){ alert('Preencha o nome da refei√ß√£o'); return; }
  const data = {
    id: editingMealId || uid('m'),
    name, calories: cal, group: mealGroup.value.trim(), substitutes: mealSubstitutes.value.trim(), allergens: mealAllergens.value.trim()
  };
  if(editingMealId){
    meals = meals.map(m=> m.id===editingMealId ? data : m);
    editingMealId = null;
  } else {
    meals.push(data);
  }
  saveMeals(meals);
  renderMealsList();
  clearMealForm();
  renderWeekBuilder();
  renderWeeksList();
});

clearMealBtn.addEventListener('click', clearMealForm);

function clearMealForm(){
  mealName.value=''; mealCalories.value=''; mealGroup.value=''; mealSubstitutes.value=''; mealAllergens.value=''; editingMealId=null;
  addMealBtn.textContent = 'Adicionar / Atualizar Refei√ß√£o';
}

function renderMealsList(){
  meals = loadMeals();
  mealsList.innerHTML = '';
  if(meals.length===0){ mealsList.innerHTML = '<div class="small">Nenhuma refei√ß√£o cadastrada.</div>'; return; }
  meals.forEach(m=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div class="meta"><div class="kv">${m.name}</div><div class="small">${m.calories} kcal ¬∑ ${m.group || ''} ${m.allergens ? ' ¬∑ Alerg: '+m.allergens : ''}</div></div>
      <div class="actions">
        <button class="btn" data-id="${m.id}" data-act="edit">Editar</button>
        <button class="btn" data-id="${m.id}" data-act="delete">Excluir</button>
      </div>`;
    mealsList.appendChild(div);
  });
  mealsList.querySelectorAll('button').forEach(btn=>{
    const id = btn.dataset.id; const act = btn.dataset.act;
    btn.addEventListener('click', ()=>{
      if(act==='edit'){
        const mm = meals.find(x=>x.id===id);
        if(!mm) return;
        editingMealId = mm.id;
        mealName.value = mm.name; mealCalories.value = mm.calories; mealGroup.value = mm.group; mealSubstitutes.value = mm.substitutes; mealAllergens.value = mm.allergens;
        addMealBtn.textContent = 'Salvar altera√ß√£o';
      } else if(act==='delete'){
        if(!confirm('Excluir refei√ß√£o?')) return;
        meals = meals.filter(x=>x.id!==id); saveMeals(meals); renderMealsList(); renderWeekBuilder(); renderWeeksList(); renderPreview();
      }
    });
  });
}

// Week builder
function renderWeekBuilder(){
  meals = loadMeals();
  weekBuilder.innerHTML = '';
  // create week start default to today monday if none set
  const today = new Date();
  if(!weekStartInput.value){
    // set to next Monday (or current week's Monday)
    const s = startOfWeekLocal(today);
    weekStartInput.value = s.toISOString().slice(0,10);
  }
  const days = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta'];
  for(let i=0;i<5;i++){
    const block = document.createElement('div'); block.style.marginTop='10px';
    block.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${days[i]}</div>`;
    ['cafe','almoco','lanche'].forEach(period=>{
      const wrap = document.createElement('div'); wrap.style.marginBottom='6px';
      const sel = document.createElement('select'); sel.className='input'; sel.dataset.day=i; sel.dataset.period=period;
      const optEmpty = document.createElement('option'); optEmpty.value=''; optEmpty.textContent='‚Äî Selecionar ‚Äî'; sel.appendChild(optEmpty);
      meals.forEach(m=>{
        const o = document.createElement('option'); o.value = m.id; o.textContent = `${m.name} (${m.calories} kcal)`;
        sel.appendChild(o);
      });
      const label = document.createElement('div'); label.style.marginTop='4px'; label.innerHTML = `<div style="font-weight:600">${period==='cafe'?'Caf√©':(period==='almoco'?'Almo√ßo':'Lanche')}</div>`;
      wrap.appendChild(label); wrap.appendChild(sel);
      block.appendChild(wrap);
    });
    weekBuilder.appendChild(block);
  }

  // try to prefill from saved week
  const key = weekKeyFromInput();
  if(weeks[key]){
    // fill selects
    const data = weeks[key];
    weekBuilder.querySelectorAll('select').forEach(s=>{
      const day = s.dataset.day; const per = s.dataset.period;
      const val = (data[day] && data[day][per]) ? data[day][per] : '';
      s.value = val;
    });
  }
  // attach onchange to update preview
  weekBuilder.querySelectorAll('select').forEach(s=> s.addEventListener('change', renderPreview));
  renderPreview();
}

function startOfWeekLocal(d){
  // returns monday date object for the week of d
  const dd = new Date(d);
  // dd.setHours(0, 0, 0, 0); // Removido para evitar desvio de fuso hor√°rio
  let day = dd.getDay(); // 0=domingo, 1=segunda, ..., 6=s√°bado
  
  // O c√°lculo correto para come√ßar na segunda-feira √©:
  // Se for domingo (0), subtrai 6 dias.
  // Se for segunda (1), subtrai 0 dias.
  // Se for ter√ßa (2), subtrai 1 dia.
  // Se for s√°bado (6), subtrai 5 dias.
  const diff = dd.getDate() - (day === 0 ? 6 : day - 1);
  
  return new Date(dd.setDate(diff));
}
function weekKeyFromInput(){
  const v = weekStartInput.value;
  if(!v) return ''; 
  // For√ßa a interpreta√ß√£o da data no fuso hor√°rio local (T12:00:00) para evitar desvios
  const dd = new Date(v + 'T12:00:00');
  const monday = startOfWeekLocal(dd);
  const y = monday.getFullYear();
  const m = (monday.getMonth() + 1).toString().padStart(2, '0');
  const d = monday.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${d}`;
}

weekStartInput.addEventListener('change', ()=>{
  updateWeekInfo();
  renderWeekBuilder();
});

function updateWeekInfo(){
  const v = weekStartInput.value;
  const weekInfo = document.getElementById('weekInfo');
  if(!v){ 
    weekInfo.textContent = '';
    return; 
  }
  
  // 1. Cria a data de forma segura (T12:00:00)
  const dd = new Date(v + 'T12:00:00');
  
  // 2. Calcula a segunda-feira correta
  const monday = startOfWeekLocal(dd);
  
  // 3. Calcula a sexta-feira (4 dias ap√≥s a segunda)
  const friday = new Date(monday);
  friday.setDate(friday.getDate() + 4);
  
  // 4. Formata a data para exibi√ß√£o
  const formatBR = (d) => {
    const day = d.getDate().toString().padStart(2,'0');
    const month = (d.getMonth()+1).toString().padStart(2,'0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  };
  
  // 5. Gera a chave (usando a l√≥gica local correta)
  const y = monday.getFullYear();
  const m = (monday.getMonth() + 1).toString().padStart(2, '0');
  const d = monday.getDate().toString().padStart(2, '0');
  const key = `${y}-${m}-${d}`;
  
  weekInfo.innerHTML = `üìÖ Semana: ${formatBR(monday)} a ${formatBR(friday)} (Chave: ${key})`;
}

function renderPreview(){
  previewGrid.innerHTML = '';
  const days = ['Seg','Ter','Qua','Qui','Sex'];
  const selects = weekBuilder.querySelectorAll('select');
  // build small two-column preview: first 4 days then last 3
  const cols = [0,1,2,3,4].map(i=>{
    const dayBlock = document.createElement('div'); dayBlock.className='preview-card';
    const dayLabel = document.createElement('div'); dayLabel.style.fontWeight='700'; dayLabel.textContent = days[i];
    dayBlock.appendChild(dayLabel);
    const times = ['cafe','almoco','lanche'];
    let total = 0;
    times.forEach(t=>{
      const sel = Array.from(selects).find(s=>s.dataset.day==i && s.dataset.period==t);
      const mealId = sel ? sel.value : '';
      const meal = meals.find(m=>m.id===mealId);
      const line = document.createElement('div'); line.style.marginTop='6px';
      if(meal){
        line.innerHTML = `<div style="font-weight:600">${t==='cafe'?'Caf√©':(t==='almoco'?'Almo√ßo':'Lanche')}</div><div class="small">${meal.name} ‚Äî ${meal.calories} kcal</div>`;
        total += Number(meal.calories) || 0;
      } else {
        line.innerHTML = `<div class="small">‚Äî n√£o definido</div>`;
      }
      dayBlock.appendChild(line);
    });
    const tot = document.createElement('div'); tot.style.marginTop='8px'; tot.style.fontWeight='700'; tot.textContent = `Total: ${total} kcal`;
    dayBlock.appendChild(tot);
    return dayBlock;
  });

  // append to previewGrid (2 columns)
  cols.forEach(c=> previewGrid.appendChild(c));
}

saveWeekBtn.addEventListener('click', ()=>{
  const key = weekKeyFromInput();
  if(!key){ alert('Escolha uma data de refer√™ncia para a semana (use o campo "Semana de refer√™ncia")'); return; }
  const selects = weekBuilder.querySelectorAll('select');
  const obj = {};
  for(let i=0;i<5;i++){
    obj[i] = {cafe:'',almoco:'',lanche:''};
  }
  selects.forEach(s=>{
    const d = s.dataset.day; const p = s.dataset.period;
    obj[d][p] = s.value || '';
  });
  weeks[key] = obj;
  saveWeeks(weeks);
  renderWeeksList();
  alert(`‚úÖ Semana salva com sucesso!\n\nChave da semana: ${key}\n\nAgora voc√™ pode visualizar este card√°pio no Visualizador Semanal navegando at√© esta data.`);
});

dupWeekBtn.addEventListener('click', ()=>{
  const key = weekKeyFromInput();
  if(!key || !weeks[key]){ alert('Selecione e salve uma semana primeiro para duplicar.'); return; }
  // create new key one week after
  const monday = new Date(key);
  monday.setDate(monday.getDate() + 7);
  const newKey = monday.toISOString().slice(0,10);
  weeks[newKey] = JSON.parse(JSON.stringify(weeks[key]));
  saveWeeks(weeks);
  renderWeeksList();
  alert('Semana duplicada para '+newKey);
});

clearWeekBtn.addEventListener('click', ()=>{
  if(!confirm('Limpar todas as sele√ß√µes desta semana?')) return;
  weekBuilder.querySelectorAll('select').forEach(s=> s.value='');
  renderPreview();
});

function renderWeeksList(){
  weeks = loadWeeks();
  weeksList.innerHTML = '';
  const keys = Object.keys(weeks).sort().reverse();
  if(keys.length===0){ weeksList.innerHTML = '<div class="small">Nenhuma semana salva ainda.</div>'; return; }
  keys.forEach(k=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div class="meta"><div class="kv">${k}</div><div class="small">Semana iniciando (segunda-feira)</div></div>
      <div class="actions">
        <button class="btn" data-key="${k}" data-act="load">Carregar</button>
        <button class="btn" data-key="${k}" data-act="delete">Excluir</button>
      </div>`;
    weeksList.appendChild(div);
  });
  weeksList.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const k = b.dataset.key, a = b.dataset.act;
      if(a==='load'){
        // set weekStart input and render
        const d = new Date(k);
        weekStartInput.value = d.toISOString().slice(0,10);
        renderWeekBuilder();
        alert('Semana carregada no construtor');
      } else if(a==='delete'){
        if(!confirm('Excluir semana '+k+'?')) return;
        delete weeks[k]; saveWeeks(weeks); renderWeeksList();
      }
    });
  });
}

// export/import
function exportJSON(){
  const payload = {meals: loadMeals(), weeks: loadWeeks()};
  const txt = JSON.stringify(payload,null,2);
  const blob = new Blob([txt], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'cardapio-export.json'; a.click(); URL.revokeObjectURL(url);
}

function importJSON(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const data = JSON.parse(ev.target.result);
        if(data.meals && data.weeks){
          if(confirm('Importar e substituir refei√ß√µes e semanas existentes?')) {
            saveMeals(data.meals); saveWeeks(data.weeks); meals = data.meals; weeks = data.weeks;
            renderMealsList(); renderWeekBuilder(); renderWeeksList(); alert('Importa√ß√£o conclu√≠da.');
          }
        } else { alert('Arquivo inv√°lido. Deve conter "meals" e "weeks".'); }
      }catch(err){ alert('Erro ao ler arquivo: '+err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
}

// helpers and init
function weekKeyFromInput(){ return weekKeyFromInputLocal(weekStartInput.value); }
function weekKeyFromInputLocal(v){
  if(!v) return '';
  // For√ßa a interpreta√ß√£o da data no fuso hor√°rio local (T12:00:00) para evitar desvios
  const dd = new Date(v + 'T12:00:00');
  const mon = startOfWeekLocal(dd);
  const y = mon.getFullYear();
  const m = (mon.getMonth() + 1).toString().padStart(2, '0');
  const d = mon.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function initSeedIfEmpty(){
  meals = loadMeals();
  weeks = loadWeeks();
  if(meals.length===0){
    meals = [
      {id:'m1',name:'P√£o integral com queijo branco',calories:180,group:'Cereal/P√£es',substitutes:'P√£o franc√™s integral',allergens:'Lactose'},
      {id:'m2',name:'Arroz integral com feij√£o',calories:350,group:'Carboidrato',substitutes:'Arroz branco',allergens:''},
      {id:'m3',name:'Frango grelhado',calories:180,group:'Prote√≠na',substitutes:'Peixe asado',allergens:''},
      {id:'m4',name:'Sopa de legumes',calories:150,group:'Sopa',substitutes:'Canja',allergens:''}
    ];
    saveMeals(meals);
  }
  if(Object.keys(weeks).length===0){
    const monday = startOfWeekLocal(new Date()).toISOString().slice(0,10);
    const obj = {};
    for(let i=0;i<5;i++){ obj[i] = {cafe:'m1',almoco:'m2',lanche:'m4'}; }
    weeks[monday] = obj; saveWeeks(weeks);
  }
  renderMealsList(); renderWeekBuilder(); renderWeeksList();
}

initSeedIfEmpty();
updateWeekInfo();

// Bot√£o Limpar Dados
document.getElementById('clearDataBtn').addEventListener('click', ()=>{
  if(confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° apagar TODOS os dados salvos (refei√ß√µes e semanas).\n\nDeseja realmente continuar?')){
    localStorage.clear();
    alert('‚úÖ Todos os dados foram limpos com sucesso!');
    location.reload();
  }
});

</script>
</body>
</html>
