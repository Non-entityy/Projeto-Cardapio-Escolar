<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Card√°pio Escolar ‚Äî Visualizador Semanal</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#2e8b57; --accent:#ff9800; --bg:#f5f7f6; --card:#fff; --muted:#6b6b6b;
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:linear-gradient(180deg,#f0fbf5,#eef7f1);color:#222;padding:20px}
.container{max-width:1100px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.title{display:flex;flex-direction:column}
.title h1{margin:0;font-size:20px;color:var(--primary)}
.title p{margin:0;font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.secondary{background:#fff;border:1px solid #ddd;color:#333}
.week-info{font-weight:600;color:#333}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px;margin-top:14px}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.date{background:var(--primary);color:#fff;padding:8px;border-radius:8px;text-align:center;font-weight:600;margin-bottom:10px}
.meal-title{display:flex;justify-content:space-between;align-items:center;font-weight:600;margin:6px 0}
.meal-item{display:flex;justify-content:space-between;align-items:center;background:#f7faf7;padding:8px;border-radius:8px;margin-bottom:8px}
.small{font-size:12px;color:var(--muted)}
.total{margin-top:8px;background:var(--accent);color:#fff;padding:8px;border-radius:8px;text-align:center;font-weight:700}
.empty{padding:18px;text-align:center;color:var(--muted)}
.footer-note{margin-top:16px;font-size:13px;color:var(--muted)}
.link-admin{font-size:13px;color:var(--primary);text-decoration:none;margin-left:10px}
.search{padding:8px;border-radius:8px;border:1px solid #ddd}
@media(max-width:600px){.header{flex-direction:column;align-items:flex-start;gap:10px}}
.clear-data-btn{position:fixed;bottom:20px;right:20px;background:#e53935;color:#fff;padding:12px 18px;border-radius:50px;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(229,57,53,0.4);font-weight:600;z-index:1000;transition:all 0.3s ease}
.clear-data-btn:hover{background:#c62828;box-shadow:0 6px 16px rgba(229,57,53,0.6);transform:translateY(-2px)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1>Card√°pio Escolar ‚Äî Visualizador Semanal</h1>
      <p>Visualize e valide o card√°pio semanal. Dados carregados localmente.</p>
    </div>
    <div class="controls">
      <button class="btn" id="prevWeekBtn">‚óÄ Semana Anterior</button>
      <div class="week-info" id="weekLabel">Semana</div>
      <button class="btn" id="nextWeekBtn">Semana Seguinte ‚ñ∂</button>
      <input id="searchMeals" class="search" placeholder="Pesquisar refei√ß√£o..." />
      <a class="link-admin" href="../admin/admin.html" target="_blank">Abrir Painel Admin</a>
    </div>
  </div>

  <div id="menuGrid" class="grid"></div>

  <div class="footer-note">
    <span class="small">Nota:</span> Para editar refei√ß√µes e configura√ß√µes do card√°pio, use o painel administrativo. Os dados s√£o persistidos no seu navegador (LocalStorage).
  </div>
</div>

<button class="clear-data-btn" id="clearDataBtn">üóëÔ∏è Limpar Dados</button>

<script>
/*
  public/index.html
  - Carrega 'meals' e 'weeks' do LocalStorage
  - Mostra a semana atual (segunda-domingo)
  - Permite navegar semanas (prev/next)
  - Calcula total de calorias por dia
  - Filtra refei√ß√µes via busca
*/

const LS_MEALS = 'meals_v1';
const LS_WEEKS = 'weeks_v1';

function loadMeals(){
  try {
    return JSON.parse(localStorage.getItem(LS_MEALS)) || [];
  } catch(e){ return []; }
}

function loadWeeks(){
  try {
    return JSON.parse(localStorage.getItem(LS_WEEKS)) || {};
  } catch(e){ return {}; }
}

// date helpers
function startOfWeek(date){
  const d = new Date(date);
  // d.setHours(0, 0, 0, 0); // Removido para evitar desvio de fuso hor√°rio
  let day = d.getDay(); // 0=domingo, 1=segunda, ..., 6=s√°bado
  
  // O c√°lculo correto para come√ßar na segunda-feira √©:
  // Se for domingo (0), subtrai 6 dias.
  // Se for segunda (1), subtrai 0 dias.
  // Se for ter√ßa (2), subtrai 1 dia.
  // Se for s√°bado (6), subtrai 5 dias.
  const diff = d.getDate() - (day === 0 ? 6 : day - 1);
  
  return new Date(d.setDate(diff));
}
function formatDate(d){
  const dd = d.getDate().toString().padStart(2,'0');
  const mm = (d.getMonth()+1).toString().padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function weekKeyFromDate(date){
  // Garante que a data seja tratada como local antes de calcular a segunda-feira
  // Se for string (do input), usa T12:00:00 para for√ßar local no meio do dia.
  const d = (typeof date === 'string') ? new Date(date + 'T12:00:00') : new Date(date);
  const s = startOfWeek(d);
  const y = s.getFullYear();
  const m = (s.getMonth() + 1).toString().padStart(2, '0');
  const dd = s.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${dd}`;
}

let currentWeekStart = startOfWeek(new Date());
let meals = loadMeals();
let weeks = loadWeeks();
let query = '';

document.getElementById('prevWeekBtn').addEventListener('click', ()=>{
  currentWeekStart.setDate(currentWeekStart.getDate() - 7);
  renderWeek();
});
document.getElementById('nextWeekBtn').addEventListener('click', ()=>{
  currentWeekStart.setDate(currentWeekStart.getDate() + 7);
  renderWeek();
});
document.getElementById('searchMeals').addEventListener('input', (e)=>{
  query = e.target.value.trim().toLowerCase();
  renderWeek();
});

function getWeekPlan(key){
  return weeks[key] || null;
}

// UI
function renderWeek(){
  // Recarregar dados do localStorage para garantir sincroniza√ß√£o
  meals = loadMeals();
  weeks = loadWeeks();
  
  const grid = document.getElementById('menuGrid');
  grid.innerHTML = '';
  const weekKey = weekKeyFromDate(currentWeekStart);
  const weekPlan = getWeekPlan(weekKey);
  const start = new Date(currentWeekStart);
  const end = new Date(currentWeekStart); end.setDate(end.getDate() + 4); // friday
  document.getElementById('weekLabel').textContent = `Semana ${formatDate(start)} ‚Äî ${formatDate(end)}`;

  if(!weekPlan){
    // empty state
    const emptyCard = document.createElement('div');
    emptyCard.className = 'card';
    emptyCard.innerHTML = `<div class="empty"><strong>Nenhum card√°pio salvo para esta semana.</strong><div class="small">Semana: ${weekKey}<br>Abra o Painel Admin ‚Üí Selecione a data de refer√™ncia ‚Üí Monte o card√°pio ‚Üí Clique em "Salvar Semana".</div></div>`;
    grid.appendChild(emptyCard);
    return;
  }

  // weekPlan expected: {dayIndex: {cafe: mealId, almoco: mealId, lanche: mealId}, ...}
  for(let i=0;i<5;i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    const card = document.createElement('div');
    card.className = 'card';
    const dayKey = i.toString();
    const dayPlan = weekPlan[dayKey] || {};
    const dateBox = document.createElement('div');
    dateBox.className = 'date';
    dateBox.textContent = `${['Seg','Ter','Qua','Qui','Sex'][i]} ‚Ä¢ ${formatDate(d)}`;
    card.appendChild(dateBox);

    const times = [
      {k:'cafe', label:'Caf√© da Manh√£'},
      {k:'almoco', label:'Almo√ßo'},
      {k:'lanche', label:'Lanche'}
    ];

    let totalDayCalories = 0;
    times.forEach(t=>{
      const mealId = dayPlan[t.k];
      const meal = meals.find(m=>m.id === mealId);
      const mm = document.createElement('div');
      mm.className = 'meal-title';
      mm.innerHTML = `<div> ${t.label}</div><div class="small"> ${meal ? meal.group || '' : '‚Äî'}</div>`;
      card.appendChild(mm);

      if(meal){
        // filter by search query if present
        const textToSearch = `${meal.name} ${meal.group} ${meal.allergens || ''}`.toLowerCase();
        if(query && !textToSearch.includes(query)){
          const note = document.createElement('div'); note.className='meal-item'; note.innerHTML=`<div class="small">‚Äî N√£o corresponde ao filtro</div>`; card.appendChild(note);
        } else {
          const mi = document.createElement('div'); mi.className='meal-item';
          mi.innerHTML = `<div>${meal.name}<div class="small">${meal.substitutes ? 'Substitui: '+meal.substitutes : ''}</div></div><div class="calories">${meal.calories} kcal</div>`;
          card.appendChild(mi);
        }
        totalDayCalories += Number(meal.calories) || 0;
      } else {
        const empty = document.createElement('div'); empty.className='meal-item'; empty.innerHTML=`<div class="small">‚Äî N√£o definido</div>`; card.appendChild(empty);
      }
    });

    const total = document.createElement('div'); total.className='total'; total.textContent = `Total do dia: ${totalDayCalories} kcal`;
    card.appendChild(total);

    grid.appendChild(card);
  }
}

// initialize sample if none exists
(function ensureSeed(){
  if(meals.length === 0){
    meals = [
      {id: 'm1', name:'P√£o integral com queijo branco', calories:180, group:'Cereal/P√£es', substitutes:'P√£o franc√™s integral', allergens:'Lactose'},
      {id: 'm2', name:'Frango grelhado', calories:180, group:'Prote√≠na', substitutes:'Peixe assado', allergens:''},
      {id: 'm3', name:'Arroz integral com feij√£o', calories:350, group:'Carboidrato + Leguminosa', substitutes:'Arroz branco', allergens:''},
      {id: 'm4', name:'Sopa de legumes', calories:150, group:'Sopa', substitutes:'Canja', allergens:''}
    ];
    localStorage.setItem(LS_MEALS, JSON.stringify(meals));
  }
  if(Object.keys(weeks).length === 0){
    // create a sample week using these meals
    const key = weekKeyFromDate(new Date());
    weeks[key] = {};
    for(let i=0;i<5;i++){
      weeks[key][i] = {cafe:'m1', almoco:'m3', lanche:'m4'};
    }
    localStorage.setItem(LS_WEEKS, JSON.stringify(weeks));
  }
})();

renderWeek();

// Bot√£o Limpar Dados
document.getElementById('clearDataBtn').addEventListener('click', ()=>{
  if(confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° apagar TODOS os dados salvos (refei√ß√µes e semanas).\n\nDeseja realmente continuar?')){
    localStorage.clear();
    alert('‚úÖ Todos os dados foram limpos com sucesso!');
    location.reload();
  }
});

</script>
</body>
</html>